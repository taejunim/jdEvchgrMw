<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jdEvchgrMw.user.service.impl.UserMapper">

    <select id="userAuthSelect" parameterType="userVO" resultType="egovMap">

        SELECT MEMSH_CARD_NO
             , CUST_ID
             , PAY_KIND_CD
             , SPOT_PAY_YN
             , STOP_YN
             , STOP_RSN
             , VALID_YN
             , REG_UID
             , REG_DT
             , MOD_UID
             , MOD_DT

          FROM memsh_card_info

         WHERE 1=1

           AND MEMSH_CARD_NO = #{memAuthInputNo}

    </select>

    <select id="userPriceSelect" parameterType="userVO" resultType="java.lang.String">

        SELECT PRICE

          FROM cust_price_info

         WHERE 1=1

           AND CUST_ID = (SELECT mci.CUST_ID CUST_ID FROM mem_card_info mci WHERE MEMSH_CARD_NO = #{memAuthInputNo})

           <![CDATA[
           AND COST_SDD < NOW() AND COST_EDD >= NOW()
           ]]>

    </select>

    <insert id="userAuthListInert" parameterType="userVO">

        INSERT INTO mem_auth_list (
                                    (SELECT CONCAT(DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(IFNULL(max(right(mal.MEM_AUTH_ID,5)), 0)+1, 8, '0')) AS MEM_AUTH_ID
                                        FROM mem_auth_list mal
                                        WHERE LEFT(mal.MEM_AUTH_ID, 8) = DATE_FORMAT(NOW(), '%Y%m%d')
                                    )
                                  , PROVIDER_ID
                                  , ST_ID
                                  , CHGR_ID
                                  , CH_ID
                                  , MW_KIND_CD
                                  , MEM_AUTH_REQ_DT
                                  , MEM_AUTH_INPUT_NO
                                  , RES_DT
                                  , AUTH_RSLT_CD
                                  , SPOT_PAY_YN
                                  , CHGR_PAYING_YN
                                  , MEM_PROVIDER_ID
                                  , PRICE
                                  , CHGR_TX_DT
                                  , REG_DT
                        ) VALUES (
                                    MEM_AUTH_ID
                                  , #{providerId}
                                  , #{stId}
                                  , #{chgrId}
                                  , #{chId}
                                  , #{mwKindCd}
                                  , #{memAuthReqDt}
                                  , #{memAuthInputNo}
                                  , #{resDt}
                                  , #{authRsltCd}
                                  , #{spotPayYn}
                                  , #{chgrPayingYn}
                                  , #{memProviderId}
                                  , #{price}
                                  , #{chgrTxDt}
                                  , now()
                                  )

    </insert>

</mapper>

